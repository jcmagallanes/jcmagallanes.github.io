<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chordinates ðŸŽ¶</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

  <div class="w-full max-w-3xl bg-white rounded-2xl shadow-lg p-6 mt-6">
    <h1 class="text-2xl font-bold text-center text-amber-600 mb-6">Chordinates ðŸŽµ</h1>

    <div class="flex flex-col md:flex-row gap-3 mb-4">
      <input id="songTitle" type="text" placeholder="Song title" class="flex-1 border border-gray-300 rounded-lg p-2" />
      <input id="songChord" type="text" placeholder="Chord" class="flex-1 border border-gray-300 rounded-lg p-2" />
      <input id="songLink" type="url" placeholder="Reference link (YouTube, Spotify, Vimeo, etc)" class="flex-1 border border-gray-300 rounded-lg p-2" />
    </div>

    <div class="flex justify-between items-center mb-6">
      <label class="flex items-center space-x-2">
        <input id="saveForever" type="checkbox" class="accent-amber-600">
        <span class="text-sm text-gray-600">Save Forever (no expiration)</span>
      </label>
      <button id="addSong" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700">Add Song</button>
    </div>

    <div id="songList" class="space-y-3"></div>

    <button id="clearSongs" class="mt-6 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
      Clear All Songs
    </button>
  </div>

  <script>
    const STORAGE_KEY = 'chordnotes_data'
    const EXPIRATION_HOURS = 24

    function setWithExpiry(key, value, ttlHours) {
      const now = new Date()
      const item = {
        value: value,
        expiry: now.getTime() + ttlHours * 60 * 60 * 1000
      }
      localStorage.setItem(key, JSON.stringify(item))
    }

    function getWithExpiry(key) {
      const itemStr = localStorage.getItem(key)
      if (!itemStr) return null
      const item = JSON.parse(itemStr)
      const now = new Date()
      if (now.getTime() > item.expiry && !item.value.some(s => s.saveForever)) {
        localStorage.removeItem(key)
        return null
      }
      return item.value
    }

    let songs = getWithExpiry(STORAGE_KEY) || []
    renderSongs(songs)

    function saveSongs() {
      setWithExpiry(STORAGE_KEY, songs, EXPIRATION_HOURS)
    }

    document.getElementById('addSong').addEventListener('click', () => {
      const title = document.getElementById('songTitle').value.trim()
      const chord = document.getElementById('songChord').value.trim()
      const link = document.getElementById('songLink').value.trim()
      const saveForever = document.getElementById('saveForever').checked

      if (!title || !chord) return alert('Please enter both title and chord.')

      songs.push({ title, chord, link, saveForever, notes: [] })
      saveSongs()
      renderSongs(songs)

      document.getElementById('songTitle').value = ''
      document.getElementById('songChord').value = ''
      document.getElementById('songLink').value = ''
      document.getElementById('saveForever').checked = false
    })

    document.getElementById('clearSongs').addEventListener('click', () => {
      if (confirm('Clear all songs?')) {
        songs = []
        saveSongs()
        renderSongs(songs)
      }
    })

    function getEmbedHTML(url) {
      if (!url) return ''
      const youtubeMatch = url.match(/(?:youtube\.com.*v=|youtu\.be\/)([a-zA-Z0-9_-]+)/)
      if (youtubeMatch) {
        return `<iframe class="rounded-lg w-full mt-2" height="200" src="https://www.youtube.com/embed/${youtubeMatch[1]}" frameborder="0" allowfullscreen></iframe>`
      }

      const vimeoMatch = url.match(/vimeo\.com\/(\d+)/)
      if (vimeoMatch) {
        return `<iframe class="rounded-lg w-full mt-2" height="200" src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen></iframe>`
      }

      const spotifyMatch = url.match(/open\.spotify\.com\/(track|album|playlist)\/([a-zA-Z0-9]+)/)
      if (spotifyMatch) {
        return `<iframe class="rounded-lg w-full mt-2" height="152" src="https://open.spotify.com/embed/${spotifyMatch[1]}/${spotifyMatch[2]}" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`
      }

      return `<a href="${url}" target="_blank" class="text-amber-600 underline text-sm">Reference Link</a>`
    }

    function renderSongs(songs) {
      const list = document.getElementById('songList')
      list.innerHTML = ''
      songs.forEach((song, index) => {
        const div = document.createElement('div')
        div.className = 'bg-amber-50 border border-amber-200 rounded-lg p-4'
        div.dataset.index = index
        div.innerHTML = `
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
              <h3 class="font-semibold text-lg">${song.title}</h3>
              <p class="text-sm text-gray-600">Chord: <span class="font-medium">${song.chord}</span></p>
              ${getEmbedHTML(song.link)}
              ${song.saveForever ? '<p class="text-xs text-green-600 mt-1">Saved Forever</p>' : ''}
            </div>
            <div class="flex gap-2 mt-2 md:mt-0">
              <button class="addNote bg-amber-600 text-white px-3 py-1 rounded-lg">Add Note</button>
              <button class="delete bg-red-500 text-white px-3 py-1 rounded-lg">Delete</button>
            </div>
          </div>
          <div class="notes mt-3 space-y-2">
            ${song.notes.map((note, i) => `
              <div class="flex justify-between bg-white border rounded-lg p-2">
                <p class="text-sm text-gray-700">${note}</p>
                <button class="deleteNote text-red-500 text-xs" data-note="${i}">âœ•</button>
              </div>
            `).join('')}
          </div>
        `
        list.appendChild(div)
      })
    }

    document.getElementById('songList').addEventListener('click', e => {
      const index = e.target.closest('[data-index]')?.dataset.index
      if (e.target.classList.contains('delete')) {
        songs.splice(index, 1)
        saveSongs()
        renderSongs(songs)
      }
      if (e.target.classList.contains('addNote')) {
        const note = prompt('Enter a note for this song:')
        if (note) {
          songs[index].notes.push(note)
          saveSongs()
          renderSongs(songs)
        }
      }
      if (e.target.classList.contains('deleteNote')) {
        const noteIndex = e.target.dataset.note
        songs[index].notes.splice(noteIndex, 1)
        saveSongs()
        renderSongs(songs)
      }
    })

    new Sortable(document.getElementById('songList'), {
      animation: 150,
      onEnd: () => {
        const reordered = Array.from(document.querySelectorAll('#songList > div')).map(div => {
          const index = div.dataset.index
          return songs[index]
        })
        songs = reordered
        saveSongs()
        renderSongs(songs)
      }
    })
  </script>
</body>
</html>
